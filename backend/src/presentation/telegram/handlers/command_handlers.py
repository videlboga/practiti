from __future__ import annotations

"""
üìã –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram Bot

–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: /start, /help –∏ –¥—Ä—É–≥–∏–µ.
–ü—Ä–∏–Ω—Ü–∏–ø CyberKitty: –ø—Ä–æ—Å—Ç–æ—Ç–∞ –ø—Ä–µ–≤—ã—à–µ –≤—Å–µ–≥–æ.
"""

import logging
from telegram import Update, InlineKeyboardMarkup, InlineKeyboardButton
from telegram.ext import ContextTypes

from .base_handler import BaseHandler
from ....services.protocols.client_service import ClientServiceProtocol
from ....services.protocols.notification_service import NotificationServiceProtocol
from ....models.client import ClientStatus, ClientUpdateData
from .. import templates as tpl

logger = logging.getLogger(__name__)


class CommandHandlers(BaseHandler):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞.
    
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç:
    - /start - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    - /help - —Å–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
    - /classes (/my_bookings) ‚Äì —Å–ø–∏—Å–æ–∫ –±—É–¥—É—â–∏—Ö –∑–∞–ø–∏—Å–µ–π
    """
    
    def __init__(
        self,
        client_service: ClientServiceProtocol,
        booking_service: "BookingServiceProtocol | None" = None,
        notification_service: "NotificationServiceProtocol | None" = None,
    ) -> None:
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–æ–º–∞–Ω–¥.

        Args:
            client_service: –°–µ—Ä–≤–∏—Å –∫–ª–∏–µ–Ω—Ç–æ–≤
            booking_service: –°–µ—Ä–≤–∏—Å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π (–º–æ–∂–µ—Ç –±—ã—Ç—å None –≤ —Ç–µ—Å—Ç–∞—Ö)
            notification_service: –°–µ—Ä–≤–∏—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–º–æ–∂–µ—Ç –±—ã—Ç—å None –≤ —Ç–µ—Å—Ç–∞—Ö)
        """
        super().__init__(client_service)
        self.booking_service = booking_service
        self.notification_service = notification_service
        logger.info("CommandHandlers –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    
    async def handle(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –º–µ—Ç–æ–¥–∞.
        
        –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–∞—Ö.
        """
        pass
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start.
        
        –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.
        """
        await self.log_command(update, "start")
        
        try:
            user_id, username, first_name = await self.get_user_info(update)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            existing_client = await self.client_service.get_client_by_telegram_id(user_id)
            
            if existing_client and existing_client.status == ClientStatus.ACTIVE:
                # –ê–≤—Ç–æ-–∫–æ—Ä—Ä–µ–∫—Ü–∏—è –∏–º–µ–Ω–∏, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏–ª –µ–≥–æ –≤ Telegram
                if first_name and first_name != existing_client.name:
                    await self.client_service.update_client(
                        existing_client.id,
                        ClientUpdateData(name=first_name),
                    )
                    existing_client.name = first_name  # –æ–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                    logger.info(
                        "–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å %s –Ω–∞ %s –ø–æ –¥–∞–Ω–Ω—ã–º Telegram",
                        existing_client.name,
                        first_name,
                    )

                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                welcome_message = tpl.welcome_back(existing_client.name)
                
                logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /start: —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–ª–∏–µ–Ω—Ç {existing_client.name}")
            else:
                # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                welcome_message = tpl.welcome_new(first_name)
                
                logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /start: –Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å @{username}")
            
            if update.effective_chat:
                await update.effective_chat.send_message(welcome_message)
                
        except Exception as e:
            await self.handle_error(update, context, e)
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /help.
        
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.
        """
        await self.log_command(update, "help")
        
        try:
            user_id, _, _ = await self.get_user_info(update)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            existing_client = await self.client_service.get_client_by_telegram_id(user_id)
            
            if existing_client and existing_client.status == ClientStatus.ACTIVE:
                # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                help_message = tpl.help_registered()
                
                logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /help: –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–ª–∏–µ–Ω—Ç {existing_client.name}")
            else:
                # –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                help_message = tpl.help_unregistered()
                
                logger.info("–ö–æ–º–∞–Ω–¥–∞ /help: –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
            
            if update.effective_chat:
                await update.effective_chat.send_message(help_message, parse_mode='Markdown')
                
        except Exception as e:
            await self.handle_error(update, context, e)
    
    async def info_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /info.
        
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç—É–¥–∏–∏.
        """
        await self.log_command(update, "info")
        
        try:
            info_message = (
                "üßò‚Äç‚ôÄÔ∏è **Practiti - –ô–æ–≥–∞ –°—Ç—É–¥–∏—è**\n\n"
                "‚ú® **–ù–∞—à–∞ –º–∏—Å—Å–∏—è:**\n"
                "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –≥–∞—Ä–º–æ–Ω–∏–∏, –≥–¥–µ –∫–∞–∂–¥—ã–π –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ "
                "—Å–≤–æ–π –ø—É—Ç—å –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–º—É —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—é —á–µ—Ä–µ–∑ –ø—Ä–∞–∫—Ç–∏–∫—É –π–æ–≥–∏.\n\n"
                "üåü **–ù–∞—à–∏ –ø—Ä–∏–Ω—Ü–∏–ø—ã:**\n"
                "‚Ä¢ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ –∫–∞–∂–¥–æ–º—É\n"
                "‚Ä¢ –ê—Ç–º–æ—Å—Ñ–µ—Ä–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏\n"
                "‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ\n\n"
                "üîπ **–ß—Ç–æ –º—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º:**\n"
                "‚Ä¢ –•–∞—Ç—Ö–∞-–π–æ–≥–∞ –¥–ª—è –≤—Å–µ—Ö —É—Ä–æ–≤–Ω–µ–π\n"
                "‚Ä¢ –í–∏–Ω—å—è—Å–∞-—Ñ–ª–æ—É\n"
                "‚Ä¢ –ô–æ–≥–∞ –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö\n"
                "‚Ä¢ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è\n"
                "‚Ä¢ –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã –∏ —Å–µ–º–∏–Ω–∞—Ä—ã\n\n"
                "üìû **–ö–æ–Ω—Ç–∞–∫—Ç—ã:**\n"
                "/address - –∞–¥—Ä–µ—Å —Å—Ç—É–¥–∏–∏\n"
                "/contact - —Å–≤—è–∑—å —Å –Ω–∞–º–∏\n\n"
                "üíö –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∏—Ä –π–æ–≥–∏!"
            )
            
            if update.effective_chat:
                await update.effective_chat.send_message(info_message, parse_mode='Markdown')
                
            logger.info("–ö–æ–º–∞–Ω–¥–∞ /info –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
                
        except Exception as e:
            await self.handle_error(update, context, e)
    
    async def register_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /register.
        
        –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        """
        await self.log_command(update, "register")
        
        try:
            user_id, username, first_name = await self.get_user_info(update)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            existing_client = await self.client_service.get_client_by_telegram_id(user_id)
            
            if existing_client and existing_client.status == ClientStatus.ACTIVE:
                # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                already_registered_message = (
                    f"‚úÖ {existing_client.name}, –≤—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!\n\n"
                    f"üìã –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥\n"
                    f"üßò‚Äç‚ôÄÔ∏è –ò–ª–∏ /schedule –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π"
                )
                
                if update.effective_chat:
                    await update.effective_chat.send_message(already_registered_message)
                    
                logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /register: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {existing_client.name} —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω")
                return
            else:
                # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –∫ registration handlers
                # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å RegistrationHandlers
                register_message = (
                    "üìù **–ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é!**\n\n"
                    "–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–π–º–µ—Ç –≤—Å–µ–≥–æ 2-3 –º–∏–Ω—É—Ç—ã.\n"
                    "–Ø –∑–∞–¥–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –∏–¥–µ–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è –¥–ª—è –≤–∞—Å.\n\n"
                    "‚è≠Ô∏è –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥–æ–π /skip\n"
                    "‚ùå –û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é: /cancel\n\n"
                    "–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å? üöÄ"
                )
                
                # –°–æ–∑–¥–∞–µ–º –∏–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏
                keyboard = [
                    [InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é", callback_data="start_registration")],
                    [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_registration")]
                ]
                reply_markup = InlineKeyboardMarkup(keyboard)
                
                if update.effective_chat:
                    await update.effective_chat.send_message(
                        register_message, 
                        parse_mode='Markdown',
                        reply_markup=reply_markup
                    )
                
                # TODO: –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—ã–∑–æ–≤ RegistrationHandlers.start_registration()
                logger.info(f"–ö–æ–º–∞–Ω–¥–∞ /register: –Ω–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è @{username}")
                
        except Exception as e:
            await self.handle_error(update, context, e)

    async def clear_registration_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /clear_registration.
        
        –û—á–∏—â–∞–µ—Ç —Ç–µ–∫—É—â—É—é —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏).
        """
        await self.log_command(update, "clear_registration")
        
        try:
            user_id, username, _ = await self.get_user_info(update)
            
            # --- –ß–∏—Å—Ç–∏–º –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (—á–µ—Ä–Ω–æ–≤–∏–∫–∏) ---
            # –ü–æ–ª—É—á–∞–µ–º registration_service –∏–∑ application.bot_data
            bot_instance = context.application.bot_data.get('bot_instance')
            if bot_instance and hasattr(bot_instance, 'registration_service'):
                registration_service = bot_instance.registration_service
                
                # –û—á–∏—â–∞–µ–º –í–°–ï —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                count = registration_service.clear_all_registrations()
                
                # --- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø–æ Telegram ID ---
                removed_client = None
                try:
                    client = await self.client_service.get_client_by_telegram_id(user_id)
                    if client:
                        await self.client_service.delete_client(client.id)
                        removed_client = client.name
                except Exception as cleanup_err:
                    logger.warning(f"–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ: {cleanup_err}")

                extra = f", –ø—Ä–æ—Ñ–∏–ª—å {removed_client} —É–¥–∞–ª—ë–Ω" if removed_client else ""
                message = (
                    f"‚úÖ –û—á–∏—â–µ–Ω–æ {count} —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏{extra}.\n"
                    "–ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ —Å /register"
                )
                logger.info(f"–û—á–∏—â–µ–Ω–æ {count} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π –ø–æ –∫–æ–º–∞–Ω–¥–µ –æ—Ç @{username}")
            else:
                message = "‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–∏—Å—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"
                logger.error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å registration_service")
            
            if update.effective_chat:
                await update.effective_chat.send_message(message)
                
        except Exception as e:
            await self.handle_error(update, context, e)

    async def address_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /address.
        
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∞–¥—Ä–µ—Å —Å—Ç—É–¥–∏–∏ –∏ –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
        """
        await self.log_command(update, "address")
        
        try:
            address_message = (
                "üìç **–ê–¥—Ä–µ—Å –π–æ–≥–∞-—Å—Ç—É–¥–∏–∏ Practiti:**\n\n"
                "üè¢ **–û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª:**\n"
                "–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, –¥. 123\n"
                "–º. –ü—Ä–∏–º–µ—Ä–Ω–∞—è (5 –º–∏–Ω –ø–µ—à–∫–æ–º)\n\n"
                "üïê **–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:**\n"
                "–ü–Ω-–ü—Ç: 07:00 - 22:00\n"
                "–°–±-–í—Å: 09:00 - 20:00\n\n"
                "üìû **–ö–æ–Ω—Ç–∞–∫—Ç—ã:**\n"
                "–¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-45-67\n"
                "WhatsApp: +7 (999) 123-45-67\n"
                "Email: info@practiti.ru\n\n"
                "üöá **–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è:**\n"
                "‚Ä¢ –û—Ç –º. –ü—Ä–∏–º–µ—Ä–Ω–∞—è - 5 –º–∏–Ω –ø–µ—à–∫–æ–º\n"
                "‚Ä¢ –ê–≤—Ç–æ–±—É—Å: –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ '–ü—Ä–∏–º–µ—Ä–Ω–∞—è —É–ª–∏—Ü–∞'\n"
                "‚Ä¢ –ü–∞—Ä–∫–æ–≤–∫–∞: –µ—Å—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è\n\n"
                "üó∫Ô∏è **–û—Ä–∏–µ–Ω—Ç–∏—Ä—ã:**\n"
                "–†—è–¥–æ–º —Å –∫–∞—Ñ–µ '–ó–¥–æ—Ä–æ–≤—å–µ' –∏ –∞–ø—Ç–µ–∫–æ–π\n"
                "–í—Ö–æ–¥ —Å–æ –¥–≤–æ—Ä–∞, 2 —ç—Ç–∞–∂\n\n"
                "üí¨ –ï—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã? –ù–∞–ø–∏—à–∏—Ç–µ /contact"
            )
            
            if update.effective_chat:
                await update.effective_chat.send_message(address_message, parse_mode='Markdown')
                
            logger.info("–ö–æ–º–∞–Ω–¥–∞ /address –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
                
        except Exception as e:
            await self.handle_error(update, context, e)

    async def faq_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /faq.
        
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã.
        """
        await self.log_command(update, "faq")
        
        try:
            faq_message = (
                "‚ùì **–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã:**\n\n"
                "**üßò‚Äç‚ôÄÔ∏è –û –∑–∞–Ω—è—Ç–∏—è—Ö:**\n\n"
                "**Q: –ù—É–∂–µ–Ω –ª–∏ –æ–ø—ã—Ç –¥–ª—è –∑–∞–Ω—è—Ç–∏–π –π–æ–≥–æ–π?**\n"
                "A: –ù–µ—Ç! –£ –Ω–∞—Å –µ—Å—Ç—å –≥—Ä—É–ø–ø—ã –¥–ª—è –Ω–∞—á–∏–Ω–∞—é—â–∏—Ö. –ö–∞–∂–¥—ã–π –Ω–∞–π–¥–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–π —É—Ä–æ–≤–µ–Ω—å.\n\n"
                "**Q: –ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π –Ω–∞ –ø–µ—Ä–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ?**\n"
                "A: –£–¥–æ–±–Ω—É—é –æ–¥–µ–∂–¥—É, –≤–æ–¥—É –∏ —Ö–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ! –ö–æ–≤—Ä–∏–∫–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º.\n\n"
                "**Q: –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è –ø—Ä–∏ —Ç—Ä–∞–≤–º–∞—Ö?**\n"
                "A: –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å–æ–æ–±—â–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—É –æ –ª—é–±—ã—Ö –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö. –ú—ã –∞–¥–∞–ø—Ç–∏—Ä—É–µ–º –ø—Ä–∞–∫—Ç–∏–∫—É.\n\n"
                "**üí≥ –û–± –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞—Ö:**\n\n"
                "**Q: –ö–∞–∫–∏–µ –µ—Å—Ç—å –≤–∏–¥—ã –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤?**\n"
                "A: –†–∞–∑–æ–≤—ã–µ –∑–∞–Ω—è—Ç–∏—è, –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –Ω–∞ 4, 8, 12 –∑–∞–Ω—è—Ç–∏–π. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏: /prices\n\n"
                "**Q: –°–∫–æ–ª—å–∫–æ –¥–µ–π—Å—Ç–≤—É–µ—Ç –∞–±–æ–Ω–µ–º–µ–Ω—Ç?**\n"
                "A: 4 –∑–∞–Ω—è—Ç–∏—è - 1 –º–µ—Å—è—Ü, 8 –∑–∞–Ω—è—Ç–∏–π - 2 –º–µ—Å—è—Ü–∞, 12 –∑–∞–Ω—è—Ç–∏–π - 3 –º–µ—Å—è—Ü–∞.\n\n"
                "**Q: –ú–æ–∂–Ω–æ –ª–∏ –∑–∞–º–æ—Ä–æ–∑–∏—Ç—å –∞–±–æ–Ω–µ–º–µ–Ω—Ç?**\n"
                "A: –î–∞, –ø—Ä–∏ –±–æ–ª–µ–∑–Ω–∏ –∏–ª–∏ –æ—Ç—ä–µ–∑–¥–µ. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.\n\n"
                "**üìÖ –û –∑–∞–ø–∏—Å–∏:**\n\n"
                "**Q: –ö–∞–∫ –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ?**\n"
                "A: –ß–µ—Ä–µ–∑ —ç—Ç–æ—Ç –±–æ—Ç –∫–æ–º–∞–Ω–¥–æ–π /book –∏–ª–∏ –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É +7 (999) 123-45-67\n\n"
                "**Q: –ó–∞ —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?**\n"
                "A: –ó–∞ 4 —á–∞—Å–∞ –¥–æ –Ω–∞—á–∞–ª–∞ –∑–∞–Ω—è—Ç–∏—è –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∑–∞–Ω—è—Ç–∏—è —Å –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞.\n\n"
                "**Q: –ß—Ç–æ –µ—Å–ª–∏ –æ–ø–æ–∑–¥–∞–ª –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ?**\n"
                "A: –ú–æ–∂–µ–º –ø—É—Å—Ç–∏—Ç—å –≤ –ø–µ—Ä–≤—ã–µ 10 –º–∏–Ω—É—Ç, –Ω–æ –ª—É—á—à–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∑–∞—Ä–∞–Ω–µ–µ.\n\n"
                "**ü§î –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã?**\n"
                "–ù–∞–ø–∏—à–∏—Ç–µ /contact –∏–ª–∏ –ø–æ–∑–≤–æ–Ω–∏—Ç–µ +7 (999) 123-45-67"
            )
            
            if update.effective_chat:
                await update.effective_chat.send_message(faq_message, parse_mode='Markdown')
                
            logger.info("–ö–æ–º–∞–Ω–¥–∞ /faq –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
                
        except Exception as e:
            await self.handle_error(update, context, e)

    async def contact_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /contact.
        
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è —Å–≤—è–∑–∏ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
        """
        await self.log_command(update, "contact")
        
        try:
            contact_message = (
                "üìû **–°–≤—è–∑—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º:**\n\n"
                "üë©‚Äçüíº **–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å—Ç—É–¥–∏–∏:**\n"
                "–ê–Ω–Ω–∞ –ü–µ—Ç—Ä–æ–≤–∞\n\n"
                "üì± **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã:**\n"
                "‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω: +7 (999) 123-45-67\n"
                "‚Ä¢ WhatsApp: +7 (999) 123-45-67\n"
                "‚Ä¢ Telegram: @practiti_admin\n"
                "‚Ä¢ Email: info@practiti.ru\n\n"
                "üïê **–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:**\n"
                "–ü–Ω-–ü—Ç: 09:00 - 21:00\n"
                "–°–±-–í—Å: 10:00 - 18:00\n\n"
                "‚ö° **–ë—ã—Å—Ç—Ä–∞—è –ø–æ–º–æ—â—å:**\n"
                "‚Ä¢ –ó–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏–µ: /book\n"
                "‚Ä¢ –í–æ–ø—Ä–æ—Å—ã –æ —Å—Ç—É–¥–∏–∏: /faq\n"
                "‚Ä¢ –ê–¥—Ä–µ—Å –∏ –ø—Ä–æ–µ–∑–¥: /address\n\n"
                "üìù **–ü–æ –∫–∞–∫–∏–º –≤–æ–ø—Ä–æ—Å–∞–º –æ–±—Ä–∞—â–∞—Ç—å—Å—è:**\n"
                "‚Ä¢ –ü–æ–∫—É–ø–∫–∞ –∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤\n"
                "‚Ä¢ –ó–∞–º–æ—Ä–æ–∑–∫–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–∞\n"
                "‚Ä¢ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è\n"
                "‚Ä¢ –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã\n"
                "‚Ä¢ –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã –∏ —Å–µ–º–∏–Ω–∞—Ä—ã\n"
                "‚Ä¢ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –±–æ—Ç–æ–º\n\n"
                "üí¨ **–ù–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ –ª—é–±–æ–µ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è!**\n"
                "–ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤ —Ä–∞–±–æ—á–∏–µ —á–∞—Å—ã."
            )
            
            if update.effective_chat:
                await update.effective_chat.send_message(contact_message, parse_mode='Markdown')
                
            logger.info("–ö–æ–º–∞–Ω–¥–∞ /contact –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
                
        except Exception as e:
            await self.handle_error(update, context, e)

    async def prices_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /prices.
        
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ü–µ–Ω—ã –Ω–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –∏ —É—Å–ª—É–≥–∏.
        """
        await self.log_command(update, "prices")
        
        try:
            prices_message = (
                "üí∞ **–¶–µ–Ω—ã –Ω–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç—ã –∏ —É—Å–ª—É–≥–∏:**\n\n"
                "üé´ **–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã –Ω–∞ –≥—Ä—É–ø–ø–æ–≤—ã–µ –∑–∞–Ω—è—Ç–∏—è:**\n\n"
                "‚Ä¢ **–†–∞–∑–æ–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ** - 1 500 ‚ÇΩ\n"
                "  –î–µ–π—Å—Ç–≤—É–µ—Ç –≤ –¥–µ–Ω—å –ø–æ–∫—É–ø–∫–∏\n\n"
                "‚Ä¢ **–ê–±–æ–Ω–µ–º–µ–Ω—Ç 4 –∑–∞–Ω—è—Ç–∏—è** - 5 200 ‚ÇΩ (1 300 ‚ÇΩ/–∑–∞–Ω—è—Ç–∏–µ)\n"
                "  –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 1 –º–µ—Å—è—Ü\n"
                "  üí° –≠–∫–æ–Ω–æ–º–∏—è: 800 ‚ÇΩ\n\n"
                "‚Ä¢ **–ê–±–æ–Ω–µ–º–µ–Ω—Ç 8 –∑–∞–Ω—è—Ç–∏–π** - 9 600 ‚ÇΩ (1 200 ‚ÇΩ/–∑–∞–Ω—è—Ç–∏–µ)\n"
                "  –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 2 –º–µ—Å—è—Ü–∞\n"
                "  üí° –≠–∫–æ–Ω–æ–º–∏—è: 2 400 ‚ÇΩ\n\n"
                "‚Ä¢ **–ê–±–æ–Ω–µ–º–µ–Ω—Ç 12 –∑–∞–Ω—è—Ç–∏–π** - 13 200 ‚ÇΩ (1 100 ‚ÇΩ/–∑–∞–Ω—è—Ç–∏–µ)\n"
                "  –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 3 –º–µ—Å—è—Ü–∞\n"
                "  üí° –≠–∫–æ–Ω–æ–º–∏—è: 4 800 ‚ÇΩ\n\n"
                "üë§ **–ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∑–∞–Ω—è—Ç–∏—è:**\n\n"
                "‚Ä¢ **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ** - 4 000 ‚ÇΩ\n"
                "  –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 90 –º–∏–Ω—É—Ç\n\n"
                "‚Ä¢ **–ü–∞—Ä–Ω–æ–µ –∑–∞–Ω—è—Ç–∏–µ** - 3 000 ‚ÇΩ/—á–µ–ª\n"
                "  –ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: 90 –º–∏–Ω—É—Ç\n\n"
                "üéÅ **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:**\n\n"
                "‚Ä¢ **–ü–µ—Ä–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ** - 1 000 ‚ÇΩ\n"
                "  –î–ª—è –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤\n\n"
                "‚Ä¢ **–°—Ç—É–¥–µ–Ω—á–µ—Å–∫–∞—è —Å–∫–∏–¥–∫–∞** - 10%\n"
                "  –ü—Ä–∏ –ø—Ä–µ–¥—ä—è–≤–ª–µ–Ω–∏–∏ —Å—Ç—É–¥–µ–Ω—á–µ—Å–∫–æ–≥–æ\n\n"
                "‚Ä¢ **–°–µ–º–µ–π–Ω—ã–π –∞–±–æ–Ω–µ–º–µ–Ω—Ç** - —Å–∫–∏–¥–∫–∞ 15%\n"
                "  –ü—Ä–∏ –ø–æ–∫—É–ø–∫–µ –æ—Ç 2-—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤\n\n"
                "üí≥ **–°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã:**\n"
                "‚Ä¢ –ù–∞–ª–∏—á–Ω—ã–µ –≤ —Å—Ç—É–¥–∏–∏\n"
                "‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞\n"
                "‚Ä¢ –ü–µ—Ä–µ–≤–æ–¥ –ø–æ –Ω–æ–º–µ—Ä—É —Ç–µ–ª–µ—Ñ–æ–Ω–∞\n"
                "‚Ä¢ QR-–∫–æ–¥ (–°–ë–ü)\n\n"
                "üìû **–ü–æ–∫—É–ø–∫–∞ –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤:**\n"
                "–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º: /contact"
            )
            
            if update.effective_chat:
                await update.effective_chat.send_message(prices_message, parse_mode='Markdown')
                
            logger.info("–ö–æ–º–∞–Ω–¥–∞ /prices –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
                
        except Exception as e:
            await self.handle_error(update, context, e)

    async def schedule_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /schedule.
        
        –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π –Ω–∞ –Ω–µ–¥–µ–ª—é.
        """
        await self.log_command(update, "schedule")
        
        try:
            schedule_message = (
                "üìÖ **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–Ω—è—Ç–∏–π:**\n\n"
                "**üåÖ –ü–û–ù–ï–î–ï–õ–¨–ù–ò–ö:**\n"
                "‚Ä¢ 08:00 - 09:30 | –•–∞—Ç—Ö–∞-–π–æ–≥–∞ (–Ω–∞—á–∏–Ω–∞—é—â–∏–µ)\n"
                "‚Ä¢ 19:00 - 20:30 | –í–∏–Ω—å—è—Å–∞-—Ñ–ª–æ—É (—Å—Ä–µ–¥–Ω–∏–π)\n"
                "‚Ä¢ 20:45 - 22:00 | –ô–æ–≥–∞-–Ω–∏–¥—Ä–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n\n"
                "**üåü –í–¢–û–†–ù–ò–ö:**\n"
                "‚Ä¢ 07:30 - 09:00 | –£—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–∞–∫—Ç–∏–∫–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n"
                "‚Ä¢ 18:30 - 20:00 | –•–∞—Ç—Ö–∞-–π–æ–≥–∞ (—Å—Ä–µ–¥–Ω–∏–π)\n"
                "‚Ä¢ 20:15 - 21:30 | –ò–Ω—å-–π–æ–≥–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n\n"
                "**üî• –°–†–ï–î–ê:**\n"
                "‚Ä¢ 08:00 - 09:30 | –ê—à—Ç–∞–Ω–≥–∞-–π–æ–≥–∞ (–ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π)\n"
                "‚Ä¢ 19:00 - 20:30 | –•–∞—Ç—Ö–∞-–π–æ–≥–∞ (–Ω–∞—á–∏–Ω–∞—é—â–∏–µ)\n"
                "‚Ä¢ 20:45 - 22:00 | –ú–µ–¥–∏—Ç–∞—Ü–∏—è (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n\n"
                "**üí´ –ß–ï–¢–í–ï–†–ì:**\n"
                "‚Ä¢ 07:30 - 09:00 | –í–∏–Ω—å—è—Å–∞-—Ñ–ª–æ—É (—Å—Ä–µ–¥–Ω–∏–π)\n"
                "‚Ä¢ 18:30 - 20:00 | –•–∞—Ç—Ö–∞-–π–æ–≥–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n"
                "‚Ä¢ 20:15 - 21:30 | –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ–ª—å–Ω–∞—è –π–æ–≥–∞\n\n"
                "**üå∏ –ü–Ø–¢–ù–ò–¶–ê:**\n"
                "‚Ä¢ 08:00 - 09:30 | –•–∞—Ç—Ö–∞-–π–æ–≥–∞ (–Ω–∞—á–∏–Ω–∞—é—â–∏–µ)\n"
                "‚Ä¢ 19:00 - 20:30 | –í–∏–Ω—å—è—Å–∞-—Ñ–ª–æ—É (—Å—Ä–µ–¥–Ω–∏–π)\n"
                "‚Ä¢ 20:45 - 22:00 | –ô–æ–≥–∞-–Ω–∏–¥—Ä–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n\n"
                "**üßò‚Äç‚ôÄÔ∏è –°–£–ë–ë–û–¢–ê:**\n"
                "‚Ä¢ 10:00 - 11:30 | –°–µ–º–µ–π–Ω–∞—è –π–æ–≥–∞ (–≤—Å–µ –≤–æ–∑—Ä–∞—Å—Ç—ã)\n"
                "‚Ä¢ 12:00 - 13:30 | –•–∞—Ç—Ö–∞-–π–æ–≥–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n"
                "‚Ä¢ 14:00 - 15:30 | –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å (—Ç–µ–º–∞ –º–µ–Ω—è–µ—Ç—Å—è)\n\n"
                "**üåÖ –í–û–°–ö–†–ï–°–ï–ù–¨–ï:**\n"
                "‚Ä¢ 10:00 - 11:30 | –£—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–∞–∫—Ç–∏–∫–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n"
                "‚Ä¢ 12:00 - 13:30 | –ò–Ω—å-–π–æ–≥–∞ (–≤—Å–µ —É—Ä–æ–≤–Ω–∏)\n"
                "‚Ä¢ 14:00 - 15:30 | –ú–µ–¥–∏—Ç–∞—Ü–∏—è –∏ –ø—Ä–∞–Ω–∞—è–º–∞\n\n"
                "**üìù –£—Ä–æ–≤–Ω–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:**\n"
                "üü¢ –ù–∞—á–∏–Ω–∞—é—â–∏–µ - –±–µ–∑ –æ–ø—ã—Ç–∞\n"
                "üü° –°—Ä–µ–¥–Ω–∏–π - –æ—Ç 6 –º–µ—Å—è—Ü–µ–≤ –ø—Ä–∞–∫—Ç–∏–∫–∏\n"
                "üî¥ –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π - –æ—Ç 2 –ª–µ—Ç –ø—Ä–∞–∫—Ç–∏–∫–∏\n\n"
                "**üìû –ó–∞–ø–∏—Å—å –Ω–∞ –∑–∞–Ω—è—Ç–∏—è:**\n"
                "‚Ä¢ –ß–µ—Ä–µ–∑ –±–æ—Ç: /book (–¥–ª—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)\n"
                "‚Ä¢ –ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É: +7 (999) 123-45-67\n"
                "‚Ä¢ –í —Å—Ç—É–¥–∏–∏ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n"
                "‚ö†Ô∏è **–í–∞–∂–Ω–æ:** –ó–∞–ø–∏—Å—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞!\n"
                "–û—Ç–º–µ–Ω–∞ –∑–∞ 4 —á–∞—Å–∞ –¥–æ –∑–∞–Ω—è—Ç–∏—è."
            )
            
            if update.effective_chat:
                await update.effective_chat.send_message(schedule_message, parse_mode='Markdown')
                
            logger.info("–ö–æ–º–∞–Ω–¥–∞ /schedule –≤—ã–ø–æ–ª–Ω–µ–Ω–∞")
                
        except Exception as e:
            await self.handle_error(update, context, e)

    async def unknown_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
        """
        –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.
        
        –ü–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã.
        """
        try:
            user_id, username, _ = await self.get_user_info(update)
            logger.info(f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –æ—Ç @{username} (ID: {user_id}): {update.message.text}")
            
            if update.effective_chat:
                await update.effective_chat.send_message(tpl.unknown_command_message())
                
        except Exception as e:
            await self.handle_error(update, context, e)

    async def classes_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:  # type: ignore[override]
        """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫ –±—É–¥—É—â–∏—Ö –∑–∞–Ω—è—Ç–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""

        await self.log_command(update, "classes")

        if not self.booking_service:
            if update.effective_chat:
                await update.effective_chat.send_message(tpl.feature_unavailable())
            return

        try:
            user_id, _, first_name = await self.get_user_info(update)

            client = await self.client_service.get_client_by_telegram_id(user_id)
            if not client:
                if update.effective_chat:
                    await update.effective_chat.send_message(
                        "üìù –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥–æ–π /register." )
                return

            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –±—É–¥—É—â–∏–µ
            bookings = await self.booking_service.list_bookings()

            from datetime import datetime
            from ....models.booking import BookingStatus

            upcoming = [
                b for b in bookings
                if b.client_id == client.id and b.status not in {BookingStatus.CANCELLED, BookingStatus.MISSED}
                and b.class_date > datetime.now()
            ]

            upcoming.sort(key=lambda b: b.class_date)

            if not upcoming:
                msg = "–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –∑–∞–ø–∏—Å–µ–π. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /book, —á—Ç–æ–±—ã –∑–∞–ø–∏—Å–∞—Ç—å—Å—è."
            else:
                lines = [
                    "üìÖ *–í–∞—à–∏ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –∑–∞–Ω—è—Ç–∏—è:*\n"
                ]
                for idx, b in enumerate(upcoming, 1):
                    dt_str = b.class_date.strftime("%d.%m %H:%M")
                    lines.append(f"{idx}. {dt_str} ‚Äî {b.class_type}")
                msg = "\n".join(lines)

            if update.effective_chat:
                await update.effective_chat.send_message(msg, parse_mode="Markdown")

        except Exception as e:
            await self.handle_error(update, context, e)

    # ------------------------------------------------------------------
    # –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∞—è / —Ç–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    # ------------------------------------------------------------------

    async def notify_test_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:  # noqa: D401
        """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

        –°–æ–∑–¥–∞—ë—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ GENERAL_INFO —á–µ—Ä–µ–∑ NotificationService –∏
        —Å—Ä–∞–∑—É –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –Ω–µ
        –¥–æ—Å—Ç—É–ø–µ–Ω). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        –¥–æ—Å—Ç–∞–≤–∫–∏.
        """

        await self.log_command(update, "notify_test")

        try:
            user_id, username, first_name = await self.get_user_info(update)

            # –ò—â–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ Telegram ID
            client = await self.client_service.get_client_by_telegram_id(user_id)

            if not client:
                # –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                if update.effective_chat:
                    await update.effective_chat.send_message(
                        "–ü–æ—Ö–æ–∂–µ, –≤—ã –µ—â—ë –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–π–¥–∏—Ç–µ /register."
                    )
                return

            # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ NotificationService
            if self.notification_service:
                from ....models.notification import NotificationType

                success = await self.notification_service.send_immediate_notification(
                    client_id=client.id,
                    notification_type=NotificationType.GENERAL_INFO,
                    template_data={
                        "client_name": client.name,
                        "message": "–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ. –í—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! ‚úÖ",
                    },
                )

                if update.effective_chat:
                    if success:
                        await update.effective_chat.send_message(tpl.test_notification_sent())
                    else:
                        await update.effective_chat.send_message(tpl.test_notification_failed())
            else:
                # Fallback: –Ω–∞–ø—Ä—è–º—É—é –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
                if update.effective_chat:
                    await update.effective_chat.send_message(tpl.test_notification_message())

        except Exception as e:
            await self.handle_error(update, context, e) 